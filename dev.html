<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Developer notes &mdash; baselayer vUndefined documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/output_cells.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Usage" href="usage.html" />
    <link rel="prev" title="Setup" href="setup.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> baselayer
          </a>
              <div class="version">
                vUndefined
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="setup.html">Setup</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Developer notes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#testing">Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#debugging">Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="#database">Database</a></li>
<li class="toctree-l2"><a class="reference internal" href="#new-sql-alchemy-2-0-style-select-statements">New SQL Alchemy 2.0 style select statements</a></li>
<li class="toctree-l2"><a class="reference internal" href="#standards">Standards</a></li>
<li class="toctree-l2"><a class="reference internal" href="#upgrading-javascript-dependencies">Upgrading Javascript dependencies</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="extending.html">Extending baselayer</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">baselayer</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Developer notes</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="developer-notes">
<h1>Developer notes<a class="headerlink" href="#developer-notes" title="Permalink to this heading"></a></h1>
<section id="testing">
<h2>Testing<a class="headerlink" href="#testing" title="Permalink to this heading"></a></h2>
<p>To execute the test suite:</p>
<ul class="simple">
<li><p>Install ChromeDriver from <a class="reference external" href="https://sites.google.com/a/chromium.org/chromedriver/home">https://sites.google.com/a/chromium.org/chromedriver/home</a></p></li>
<li><p>Install Chrome or Chromium</p></li>
<li><p>To run all tests: <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">test</span></code></p></li>
<li><p>To run a single test: <code class="docutils literal notranslate"><span class="pre">./tools/test_frontend.py</span> <span class="pre">skportal/tests/frontend/&lt;test_file&gt;.py::test_&lt;specific_test&gt;</span></code></p></li>
</ul>
<p>On Linux, the tests can be run in “headless” mode (no browser display):</p>
<ul class="simple">
<li><p>Install xfvb (<code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">xfvb</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">test_headless</span></code></p></li>
</ul>
</section>
<section id="debugging">
<h2>Debugging<a class="headerlink" href="#debugging" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p>Run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">log</span></code> to watch log output</p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">stop</span></code> to stop any running web services.</p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">attach</span></code> to attach to output of webserver, e.g. for use with <code class="docutils literal notranslate"><span class="pre">pdb.set_trace()</span></code></p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">check-js-updates</span></code> to see which Javascript packages are eligible for an upgrade.</p></li>
</ul>
</section>
<section id="database">
<h2>Database<a class="headerlink" href="#database" title="Permalink to this heading"></a></h2>
<p>All interactions with the database are performed by way of SQLAlchemy using the
Pyscopg2 backend. Some standard but not necessarily obvious usage patterns we
make use of include:</p>
<ul class="simple">
<li><p>Logic for connecting to the DB, refreshing tables, etc. is found in <code class="docutils literal notranslate"><span class="pre">baselayer/model_utils.py</span></code>:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">baselayer.app.env</span> <span class="kn">import</span> <span class="n">load_env</span>
<span class="kn">from</span> <span class="nn">baselayer.models</span> <span class="kn">import</span> <span class="n">DBSession</span><span class="p">,</span> <span class="n">init_db</span>
<span class="n">env</span><span class="p">,</span> <span class="n">cfg</span> <span class="o">=</span> <span class="n">load_env</span><span class="p">()</span>
<span class="n">init_db</span><span class="p">(</span><span class="o">**</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;database&#39;</span><span class="p">])</span>
</pre></div>
</div>
<ul class="simple">
<li><p>The session object controls various DB state operations:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">DBSession</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>  <span class="c1"># add a new object into the DB</span>
<span class="n">DBSession</span><span class="p">()</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>  <span class="c1"># commit modifications to objects</span>
<span class="n">DBSession</span><span class="p">()</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>  <span class="c1"># recover after a DB error</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Generic logic applicable to any model is included in the base model class <code class="docutils literal notranslate"><span class="pre">baselayer.app.models.Base</span></code> (<code class="docutils literal notranslate"><span class="pre">to_dict</span></code>, <code class="docutils literal notranslate"><span class="pre">__str__</span></code>, etc.), but can be overridden within a specific model</p></li>
<li><p>Models can be selected directly (<code class="docutils literal notranslate"><span class="pre">User.query.all()</span></code>), or more specific queries can be constructed via the session object (<code class="docutils literal notranslate"><span class="pre">DBSession().query(User.id).all()</span></code>)</p></li>
<li><p>Convenience functionality:</p>
<ul>
<li><p>Join relationships: some multi-step relationships are defined through joins using the <code class="docutils literal notranslate"><span class="pre">secondary</span></code> parameter to eliminate queries from the intermediate table; e.g., <code class="docutils literal notranslate"><span class="pre">User.acls</span></code> instad of <code class="docutils literal notranslate"><span class="pre">[r.acls</span> <span class="pre">for</span> <span class="pre">r</span> <span class="pre">in</span> <span class="pre">User.roles]</span></code></p></li>
<li><p><a class="reference external" href="http://docs.sqlalchemy.org/en/latest/orm/extensions/associationproxy.html">Association proxies</a>: shortcut to some attribute of a related object; e.g., <code class="docutils literal notranslate"><span class="pre">User.permissions</span></code> instead of <code class="docutils literal notranslate"><span class="pre">[a.id</span> <span class="pre">for</span> <span class="pre">a</span> <span class="pre">in</span> <span class="pre">User.acls]</span></code></p></li>
<li><p><a class="reference external" href="http://docs.sqlalchemy.org/en/latest/orm/loading_relationships.html">Joined loads</a>: this allows for a single query to also include child/related objects; often used in handlers when we know that information about related objects will also be needed.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">to_json()</span></code>: often from a handler we return an ORM object, which gets converted to JSON via <code class="docutils literal notranslate"><span class="pre">json_util.to_json(obj.to_dict())</span></code>. This also includes the attributes of any children that were loaded via <code class="docutils literal notranslate"><span class="pre">joinedload</span></code> or by accessing them directly. For example:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">User.query.first().to_dict()</span></code> will not contain information about the user’s permissions</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">u</span> <span class="pre">=</span> <span class="pre">User.query.first();</span> <span class="pre">u.acls;</span> <span class="pre">u.to_dict()</span></code> does include a list of the user’s ACLs</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</section>
<section id="new-sql-alchemy-2-0-style-select-statements">
<h2>New SQL Alchemy 2.0 style select statements<a class="headerlink" href="#new-sql-alchemy-2-0-style-select-statements" title="Permalink to this heading"></a></h2>
<p>To start a session without verification (i.e., when not committing to DB):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">DBSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
  <span class="o">...</span>
</pre></div>
</div>
<p>The context manager will make sure the connection is closed when exiting context.</p>
<p>To use a verified session that checks all rows before committing them:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">VerifiedSession</span><span class="p">(</span><span class="n">user_or_token</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
  <span class="o">...</span>
  <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>
</div>
<p>This does the same checks that are performed when calling <code class="docutils literal notranslate"><span class="pre">self.verify_and_commit()</span></code>.
Each handler class can also call <code class="docutils literal notranslate"><span class="pre">self.Session()</span></code> as a stand-in for <code class="docutils literal notranslate"><span class="pre">VerifiedSession(self.current_user)</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">Session</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
  <span class="o">...</span>
  <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>
</div>
<p>To quickly get rows from a table using the new “select” methods, use one of these (replace <code class="docutils literal notranslate"><span class="pre">User</span></code> with any class):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">id_or_list</span><span class="p">,</span> <span class="n">user_or_token</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="n">raise_if_none</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">[])</span>
<span class="n">all_users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="n">user_or_token</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="n">raise_if_none</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">[],</span> <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">stmt</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">user_or_token</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">[],</span> <span class="n">columnns</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">get</span></code> and <code class="docutils literal notranslate"><span class="pre">get_all</span></code> functions open a session internally and retrieve the objects specified,
if they are accessible to the user. In the case of <code class="docutils literal notranslate"><span class="pre">get</span></code>, if any of the IDs given (as a scalar or list)
are not accessible to do not exist in the DB, the function returns None, or raises an <code class="docutils literal notranslate"><span class="pre">AccessError</span></code>
(if <code class="docutils literal notranslate"><span class="pre">raise_if_none=True</span></code> is specified). The <code class="docutils literal notranslate"><span class="pre">get_all</span></code> just retrieves all rows that are accessible from that table.
Note that these two methods will produce an object <em>not associated with the external session, if any</em>.
Thus, if the call is made while an external context is used,
the object has to be added to that session before it can, e.g., load additional relationships,
or be saved, or do any other operation that involves the database.
As an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
  <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;read&#39;</span><span class="p">)</span>
  <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>  <span class="c1"># must have this to load additional relationships</span>
  <span class="n">tokens</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">tokens</span>  <span class="c1"># will fail if user is not in session</span>
</pre></div>
</div>
<p>On the other hand, the <code class="docutils literal notranslate"><span class="pre">select</span></code> function will return
a select statement object that only selects rows that are accessible.
This statement can be further filtered with <code class="docutils literal notranslate"><span class="pre">where()</span></code> and executed using the session:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">VerifiedSession</span><span class="p">(</span><span class="n">user_or_token</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
  <span class="n">stmt</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">user_or_token</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">)</span>
  <span class="n">user</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span><span class="o">.</span><span class="n">scalars</span><span class="p">()</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>  <span class="c1"># returns a tuple with one object</span>
  <span class="c1"># can also call session.scalars(stmt).first() to get the object directly</span>
  <span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">new_name</span>
  <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>
</div>
<p>If not using <code class="docutils literal notranslate"><span class="pre">commit()</span></code>, the call to <code class="docutils literal notranslate"><span class="pre">VerifiedSession(user_or_token)</span></code>
can be replaced with <code class="docutils literal notranslate"><span class="pre">DBSession()</span></code> with no arguments.</p>
</section>
<section id="standards">
<h2>Standards<a class="headerlink" href="#standards" title="Permalink to this heading"></a></h2>
<p>We use ESLint to ensure that our JavaScript &amp; JSX code is consistent and conforms with recommended standards.</p>
<ul class="simple">
<li><p>Install ESLint using <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">lint-install</span></code>. This will also install a git pre-commit hook so that any commit is linted before it is checked in.</p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">lint</span></code> to perform a style check</p></li>
</ul>
</section>
<section id="upgrading-javascript-dependencies">
<h2>Upgrading Javascript dependencies<a class="headerlink" href="#upgrading-javascript-dependencies" title="Permalink to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">./tools/check_js_updates.sh</span></code> script uses
<a class="reference external" href="https://github.com/dylang/npm-check"><code class="docutils literal notranslate"><span class="pre">npm-check</span></code></a> to search updates
for packages defined in <code class="docutils literal notranslate"><span class="pre">package.json</span></code>. It then provides an
interactive interface for selecting new versions and performing the upgrade.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="setup.html" class="btn btn-neutral float-left" title="Setup" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="usage.html" class="btn btn-neutral float-right" title="Usage" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017, The baselayer Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>